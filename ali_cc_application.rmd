---
title: "Disparities in Hospitalizations Based on ALI"
subtitle: "Concentration Curves Analysis"
author: "Sarah Lotspeich"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 12, fig.height = 7)
```

```{r, echo = FALSE, message = FALSE}
# Load packages
library(dplyr)
library(tidyr)
library(latex2exp)
library(ggplot2)
library(rineq)
library(ggconc)
```

```{r, echo = FALSE, message = FALSE}
# Read in data
## Demographics + ALI components
all_ali_dat <- read.csv("~/Documents/Allostatic_load_audits/all_ali_dat.csv", header=TRUE)
## Separate hospitalizations + ED visits outcomes
encounters_dat <- read.csv("~/Documents/Allostatic_load_audits/Raw_Data/hospital_ed_separate.csv")
# Merge demographics + ALI components + Hospitalizations/ED visits
all_ali_dat <- all_ali_dat |>
  left_join(y = encounters_dat) |>
  replace_na(replace = list(NUM_ADMIT = 0, NUM_ED = 0)) |> ## replace NA with 0
  mutate(ANY_ADMIT = as.numeric(NUM_ADMIT > 0), ## Define binary indicators
         ANY_ED = as.numeric(NUM_ED > 0), ## Define binary indicators
         ANY_ENCOUNTERS = ANY_ADMIT, ## Override ANY_ENCOUNTER with ANY_ADMIT
         SEX = factor(x = SEX, ## Convert SEX to factor variable
                      levels = c("Male","Female")))
# Create separate dataframe for EHR (Before Validation)
unvalid_dat <- all_ali_dat |>
  filter(DATA == "EHR (Before Validation)")

## More demographics
more_demo = read.csv("~/Documents/Allostatic_load_audits/summary_data.csv", header=TRUE) |>
  select(PAT_MRN_ID, RACE, ETHNICITY) |>
  mutate(RACE3 = if_else(RACE %in% c("American Indian or Alaska Native",
                                     "Asian Indian",
                                     "Other"), "Other Race", RACE))
unvalid_dat <- unvalid_dat |>
  left_join(more_demo)
```

## A primer on the Methods Used Herein

  - The **concentration curve** is a visual tool to examine potential disparities in a health outcome (on the y-axis) relative to an exposure that allows us to rank people from most- to least-disadvantaged (on the x-axis). If no disparity is present, the concentration curve will fall along the line of equality, suggesting that the health outcome is proportionally allocated across people regardless of their exposure. Disparities may be present if the concentration curve falls above (disparity among the most disadvantaged) or below (disparity among the least disadvantaged) the line of equality. 
  - The **concentration index** is a numeric summary of the concentration curve, specifically defined as 2 times the area between it and the line of equality. It takes on values between $-1$ (largest possible disparity among the most disadvantaged) and $1$ (largest possible disparity among the least disadvantaged), with a concentration index of $0$ suggesting no disparity. 

## Overall

#### Let's start by looking at all $1000$ patients together. 

```{r}
unvalid_dat |>
  make_conc_data(outcome_var = NUM_ADMIT,
                 rank_var = ALI,
                 rank_ascend = FALSE) |>
  make_conc_curve() +
  labs(x = "Cumulative Proportion of Patients (Ranked by Error-Prone ALI)",
       y = "Cumulative Proportion of Hospitalizations")
```

Notice that the concentration curve is **above the line of equality**, particularly from 15% onward. Thus, visually, it seems that **patients with worse (higher) values of the error-prone ALI from the EHR shoulder disproportionately more hospitalizations** than patients with better (smaller) values. For example, if you draw a vertical line up from 50% on the x-axis, you could say that "patients with the lowest 50% of ALIs experienced 60% of the hospitalizations.

```{r, include = FALSE}
ci(ineqvar = -unvalid_dat$ALI,
   outcome = unvalid_dat$NUM_ADMIT) |>
  summary()
## -0.2122881 (-0.3207622 -0.1038139)
```

The concentration index confirms a **slight disparity in hospitalizations among patients with worse whole-person health scores**, with an estimate of $-0.21$ and 95% confidence interval ($-0.32$, $-0.10$) bounded away from the null of zero.

## By Sex 

#### Suppose we stratify the analysis on sex, fitting separate concentration curves and concentration indices to male ($n=$ `r as.numeric(table(unvalid_dat$SEX)["Male"])`) and female ($n=$ `r as.numeric(table(unvalid_dat$SEX)["Female"])`) patients. 

```{r}
sex_cc = unvalid_dat |>
  make_conc_data(outcome_var = NUM_ADMIT,
                 rank_var = ALI,
                 rank_ascend = FALSE,
                 group_var = SEX) |>
  make_conc_curve() +
  scale_color_manual(values = c("#39558CFF", "#AB337CFF", "#287D8EFF",  "#E85362FF",  "#481568FF"),
                     name = "Sex") + # guide = "none") + 
  labs(x = "Cumulative Proportion of Patients (Ranked by Error-Prone ALI)",
       y = "Cumulative Proportion of Hospitalizations") +
  #facet_wrap(~Group) +
  theme(strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white"))
sex_cc
```

  - Notice that the concentration curve among male patients is **falls along the line of equality** up until about 50%, and it only deviates a bit above beyond that point. The concentration index of $-0.08$ (95% CI: $-0.25, 0.09$) agrees that there is **not really a disparity among male patients**, regardless of their whole-person health scores. 
  - The concentration curve among female patients shows **clearly deviates from the line of equality** for the entire x-axis. In fact, there is an **even larger disparity among female patients** than in the overall analysis, with an estimate of $-0.31$ and 95% confidence interval ($-0.44$, $-0.18$) bounded away from the null of zero.

```{r, include = FALSE}
ci(ineqvar = -unvalid_dat$ALI[unvalid_dat$SEX == "Male"],
   outcome = unvalid_dat$NUM_ADMIT[unvalid_dat$SEX == "Male"]) |>
  summary()
## -0.07934105 (-0.2488523 0.09017021 )
ci(ineqvar = -unvalid_dat$ALI[unvalid_dat$SEX == "Female"],
   outcome = unvalid_dat$NUM_ADMIT[unvalid_dat$SEX == "Female"]) |>
  summary()
## -0.3097126 (-0.4432892 -0.1761361)
```

## By Race 
#### Suppose we stratify the analysis on race, fitting separate concentration curves and concentration indices to White ($n=$ `r as.numeric(table(unvalid_dat$RACE3)["White or Caucasian"])`), Black or African American ($n=$ `r as.numeric(table(unvalid_dat$RACE3)["Black or African American"])`), and Other race ($n=$ `r as.numeric(table(unvalid_dat$RACE3)["Other Race"])`) patients. 

```{r}
race_cc = unvalid_dat |>
  make_conc_data(outcome_var = NUM_ADMIT,
                 rank_var = ALI,
                 rank_ascend = FALSE,
                 group_var = RACE3) |>
  make_conc_curve() +
  scale_color_manual(values = rev(c("#39558CFF", "#AB337CFF", "#287D8EFF",  "#E85362FF",  "#481568FF")),
                     name = "Race") + #guide = "none") + #
  labs(x = "Cumulative Proportion of Patients (Ranked by Error-Prone ALI)",
       y = "Cumulative Proportion of Hospitalizations") +
  #facet_wrap(~Group) +
  theme(strip.background = element_rect(fill = "black"),
        strip.text = element_text(color = "white"))
race_cc
```

  - Notice that the concentration curves among patients in each of the three race groups **falls above the line of equality**, albeit to differing degrees. 
  - The varying concentration indices, particularly between Black or African American and White or Caucasian patients (relative to those of Other races), confirm these visual differences: 
    - Among Black or African American patients, there could be a slight disparity in hospitalizations among patients with worse error-prone ALIs (concentration index = $-0.20$). However, the 95% CI ($-0.43$, $0.03$) contains the null of no disparity, perhaps due to the smaller sample size in this subgroup. 
    - Among White or Caucasian patients, there was again a slight disparity in hospitalizations among patients with worse error-prone ALIs (concentration index = $-0.22$), and the 95% CI ($-0.35$, $-0.09$) was bounded away from the null of no disparity. 
    - Among patients of other races, the concentration index was smallest but still negative ($-0.18$), and its 95% CI contained the null ($-0.57$, $0.21$). 

```{r, include = FALSE}
ci(ineqvar = -unvalid_dat$ALI[unvalid_dat$RACE3 == "Black or African American"],
   outcome = unvalid_dat$NUM_ADMIT[unvalid_dat$RACE3 == "Black or African American"]) |>
  summary()
## -0.2001342 (-0.4321174 0.03184889)

ci(ineqvar = -unvalid_dat$ALI[unvalid_dat$RACE3 == "White or Caucasian"],
   outcome = unvalid_dat$NUM_ADMIT[unvalid_dat$RACE3 == "White or Caucasian"]) |>
  summary()
## -0.2200671 (-0.3469516 -0.0931826)

ci(ineqvar = -unvalid_dat$ALI[unvalid_dat$RACE3 == "Other Race"],
   outcome = unvalid_dat$NUM_ADMIT[unvalid_dat$RACE3 == "Other Race"]) |>
  summary()
## -0.1802373 (-0.5699532 0.2094786)
```
